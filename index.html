<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Koko päivän ja pitkät tapahtumat</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1em; }
    button { padding: 0.5em 1em; font-size: 1em; margin-top: 1em; }
    ul { margin-top: 1em; }
  </style>
  <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
</head>
<body>
  <h2>Koko päivän ja pitkät tapahtumat</h2>

  <!-- Kirjautumis- ja uloskirjautumisnapit -->
  <button id="authorize_button" style="display:none">Kirjaudu Googleen</button>
  <button id="signout_button" style="display:none">Kirjaudu ulos</button>

  <ul id="events"></ul>

  <script>
    const CLIENT_ID = '369148508096-2i2l04iqj26c1sf3p68ktjlnptgel90t.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyA8I155Js5gNoCQc3vwyF6PlViagRU4QNk';
    const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    const authorizeButton = document.getElementById('authorize_button');
    const signoutButton = document.getElementById('signout_button');
    const eventsList = document.getElementById('events');

    // Ladataan Google API Client
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC],
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    // Ladataan Google Identity Services kirjasto ja asetetaan tokenClient
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if (tokenResponse.error) {
            console.error('Token error:', tokenResponse);
            return;
          }
          gapi.client.setToken({ access_token: tokenResponse.access_token });
          listUpcomingEvents();
          authorizeButton.style.display = 'none';
          signoutButton.style.display = 'inline-block';
        },
      });
      gisInited = true;
      maybeEnableButtons();
    }

    // Näytetään kirjautumisnappi, kun molemmat kirjastot ovat ladattu
    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        authorizeButton.style.display = 'inline-block';
      }
    }

    authorizeButton.onclick = () => {
      tokenClient.requestAccessToken({ prompt: '' });
    };

    signoutButton.onclick = () => {
      gapi.client.setToken(null);
      eventsList.innerHTML = '';
      authorizeButton.style.display = 'inline-block';
      signoutButton.style.display = 'none';
    };

    // Haetaan ja näytetään tulevat koko päivän ja yli päivän kestävät tapahtumat
    function listUpcomingEvents() {
      const now = new Date().toISOString();
      gapi.client.calendar.events.list({
        calendarId: 'primary',
        timeMin: now,
        showDeleted: false,
        singleEvents: true,
        maxResults: 50,
        orderBy: 'startTime',
      }).then(response => {
        const events = response.result.items;
        eventsList.innerHTML = '';

        if (!events || events.length === 0) {
          eventsList.innerHTML = '<li>Ei tulevia koko päivän tai pidempiä tapahtumia.</li>';
          return;
        }

        events.forEach(event => {
          const start = event.start.dateTime || event.start.date;
          const end = event.end.dateTime || event.end.date;

          const isAllDay = !!event.start.date;
          const isMultiDay = (new Date(end) - new Date(start)) > 24 * 60 * 60 * 1000;

          if (isAllDay || isMultiDay) {
            const li = document.createElement('li');
            li.textContent = `${event.summary} (${start} - ${end})`;
            eventsList.appendChild(li);
          }
        });

        if (eventsList.children.length === 0) {
          eventsList.innerHTML = '<li>Ei tulevia koko päivän tai pidempiä tapahtumia.</li>';
        }
      }, err => {
        console.error('Tapahtumien hakeminen epäonnistui:', err);
        eventsList.innerHTML = '<li>Tapahtumien hakeminen epäonnistui.</li>';
      });
    }
  </script>
</body>
</html>
